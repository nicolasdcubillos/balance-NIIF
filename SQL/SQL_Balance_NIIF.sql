USE AJOVECO_NE

DROP FUNCTION X_CUENTASMAYORES;
DROP FUNCTION X_BALANCE_LOGICA_CC;
DROP FUNCTION X_BALANCE_CC;
DROP FUNCTION X_SALDOCUENTA_NIIF_CC;

GO

-- SELECT * FROM X_BALANCE_CC('5', 2023, 01) ORDER BY CODIGOCTA

GO

CREATE FUNCTION [dbo].[X_CUENTASMAYORES]
(
	@CODIGOCTA char(100)
)
RETURNS @cuentas TABLE (codigocta VARCHAR(255), nombrecta VARCHAR(255))
AS
BEGIN
	DECLARE @longitud int
    DECLARE @resultado char(100)

	SET @longitud = LEN(@codigocta) - 1
    SET @resultado = NULL

    WHILE @longitud > 0 AND @resultado IS NULL
    BEGIN
		INSERT INTO @cuentas SELECT CODIGOCTA, DESCRIPCIO FROM CUENTASNIF WHERE CODIGOCTA = LEFT(@codigocta, @longitud)
        SET @longitud = @longitud - 1
    END
	RETURN;
END;

GO 

--SELECT * FROM X_BALANCE_LOGICA_CC('5232092', 2023, 01) ORDER BY CODIGOCTA
--SELECT * FROM X_BALANCE_CC('5', 2022, 01) ORDER BY CODIGOCTA
--SELECT DEBITO - CREDITO FROM SALDCONTNI WHERE CODCC =  AND CODIGOCTA =  AND PERIODO = 11 AND ANO = 2022
--SELECT dbo.X_SALDOCUENTA_NIIF_CC('20230101', '11050501', '5232092')
--SELECT * FROM SALDCONTNI WHERE CODIGOCTA = '11050501' AND CODCC = '5232092'

CREATE FUNCTION [dbo].[X_SALDOCUENTA_NIIF_CC]
(
@fecha date,
@cuenta char(200),
@codcc char(200)
)
RETURNS NUMERIC(17,2)
AS
	BEGIN
	DECLARE @valor NUMERIC(17,2)
	SELECT @valor = (
	SELECT ISNULL(SUM (TEMP.DEBITO) - SUM(TEMP.CREDITO), 0) SALDO_INICIAL FROM
	(
		SELECT
		DATEFROMPARTS(CAST(ANO AS INT),
		CASE WHEN PERIODO = 13 THEN 12 ELSE CAST (PERIODO AS INT) END, 1) FECHA, *
		FROM SALDCONTNI) TEMP
		WHERE TEMP.CODIGOCTA = @cuenta AND TEMP.CODCC = @codcc AND TEMP.FECHA < @fecha
	)
	RETURN @valor
END

GO

CREATE FUNCTION [dbo].[X_BALANCE_LOGICA_CC]
(
	@codcc char(100),
	@ano numeric,
	@periodo numeric
)
RETURNS @balance TABLE 
(
	ID INT NOT NULL PRIMARY KEY IDENTITY (1,1),
	CODIGOCTA VARCHAR(255),
	NOMBRECTA VARCHAR(255),
	CODCC VARCHAR(255),
	SALDO_INICIAL NUMERIC, 
	DEBITO NUMERIC, 
	CREDITO NUMERIC, 
	AUXILIAR NUMERIC
)
AS
BEGIN

INSERT INTO @balance 
	SELECT 
	SALDCONTNI.CODIGOCTA, 
	CUENTASNIF.DESCRIPCIO,
	SALDCONTNI.CODCC,
	dbo.X_SALDOCUENTA_NIIF_CC(DATEFROMPARTS(CAST(@ano AS INT), CAST(@periodo AS INT), 1), SALDCONTNI.CODIGOCTA, CODCC) SALDO_INICIAL,
	SUM(DEBITO) DEBITO, 
	SUM(CREDITO) CREDITO,
	1 AUXILIAR
	FROM 
	SALDCONTNI,
	CUENTASNIF
	WHERE 
	CODCC LIKE RTRIM(@codcc) + '%' AND
	ANO = @ano AND 
	PERIODO = @periodo AND
	CUENTASNIF.CODIGOCTA = SALDCONTNI.CODIGOCTA
	GROUP BY 
	SALDCONTNI.CODIGOCTA, SALDCONTNI.CODCC, CUENTASNIF.DESCRIPCIO

	DECLARE @RowsToProcess  int
	DECLARE @CurrentRow     int
	DECLARE @cuentaBuscar   VARCHAR(255)

	SET @RowsToProcess = @@ROWCOUNT

	SET @CurrentRow=0
	WHILE @CurrentRow<@RowsToProcess
	BEGIN
		SET @CurrentRow = @CurrentRow + 1
		SELECT
			@cuentaBuscar = CODIGOCTA
			FROM @balance
			WHERE ID = @CurrentRow
		INSERT INTO @balance SELECT CODIGOCTA, NOMBRECTA, @codcc, 0, 0, 0, 0 FROM X_CUENTASMAYORES(@cuentaBuscar)
	END;
RETURN
END;

GO

CREATE FUNCTION [dbo].[X_BALANCE_CC]
(
	@codcc char(100),
	@ano numeric,
	@periodo numeric
)
RETURNS TABLE
AS
RETURN 
(
	SELECT 
	BAL.CODIGOCTA,
	BAL.CODCC,
	BAL.NOMBRECTA,
	CASE 
	WHEN 
	BAL.AUXILIAR = 1 
	THEN 
	SUM(BAL.SALDO_INICIAL) 
	ELSE 
	(SELECT SUM(SALDO_INICIAL) FROM X_BALANCE_LOGICA_CC(@codcc, @ano, @periodo) WHERE CODIGOCTA LIKE RTRIM(BAL.CODIGOCTA) + '%') 
	END 
	SALDO_INICIAL,	
	CASE 
	WHEN 
	BAL.AUXILIAR = 1 
	THEN 
	SUM(BAL.DEBITO) 
	ELSE 
	(SELECT SUM(DEBITO) FROM X_BALANCE_LOGICA_CC(@codcc, @ano, @periodo) WHERE CODIGOCTA LIKE RTRIM(BAL.CODIGOCTA) + '%') 
	END 
	DEBITO, 
	CASE 
	WHEN 
	BAL.AUXILIAR = 1 
	THEN 
	SUM(BAL.CREDITO) 
	ELSE
	(SELECT SUM(CREDITO) FROM X_BALANCE_LOGICA_CC(@codcc, @ano, @periodo) WHERE CODIGOCTA LIKE RTRIM(BAL.CODIGOCTA) + '%')
	END 
	CREDITO,
	BAL.AUXILIAR
	FROM 
	X_BALANCE_LOGICA_CC(@codcc, @ano, @periodo) BAL
	GROUP BY CODIGOCTA, NOMBRECTA, CODCC, AUXILIAR, SALDO_INICIAL
)